var FlexDigest={keyspace:1e9,sum:0,hash:function(e){return FlexDigest.sum=0,e.toString().split("").map(function(e){FlexDigest.sum+=e.charCodeAt(0),FlexDigest.sum=FlexDigest.sum%FlexDigest.keyspace}),FlexDigest.sum.toString(36)}},Refresh={elements:[],stack:{},pollInterval:3,urlTable:{},timeout:1e3,showingNotification:!1,mustMatch:/.*/,mustNotMatch:/refresh\.js/,debugLevel:0,selfDestruct:!1,webSocketUrl:"ws://127.0.0.1:3001",socket:null,updateStrategy:"polling",rldPrefs:"",formStates:"",init:function(){this.scanDOM(),setTimeout(Refresh.restoreState,1e3),this.debug("update strategy is "+this.updateStrategy,1),setTimeout(function(){Refresh.poll()},this.timeout)},debug:function(e,t){t<=this.debugLevel&&console.log(e)},jsCallback:function(e){Refresh.selfDestruct||(Refresh.lastCallback=function(){Refresh.jsCallback(e)},Refresh.saveState(),Refresh.showNotification(e.src)&&("websocket"===this.updateStrategy?document.location.href=document.location.href:setTimeout(function(){document.location.href=document.location.href},1e3),this.selfDestruct=!0))},imgCallback:function(e){this.selfDestruct||(e.src=this.uncacheUrl(e.src))},bgimgCallback:function(e){if(!this.selfDestruct){var t=e.style.backgroundImage,r=t.match(/url\('?"?([^"]+)'?"?\)/i);this.debug("parsed background image "+r[1],2),e.style.backgroundImage="url("+Refresh.uncacheUrl(r[1])+")",e.src=Refresh.uncacheUrl(e.src)}},cssCallback:function(e){if(!this.selfDestruct&&(Refresh.lastCallback=function(){Refresh.cssCallback(e)},Refresh.showNotification(e.href))){var t=Refresh.uncacheUrl(e.href);e.setAttribute("href",t)}},scanDOM:function(){for(var e=document.getElementsByTagName("*"),t=0;t<e.length;t++){var r=e[t];Refresh.skips(r)||this.elements.push(r)}},websocketInit:function(){try{this.socket=new WebSocket(this.webSocketUrl),this.socket.onerror=function(e){Refresh.debug("WebSocket Error: "+e.data,1)},this.socket.onopen=function(e){Refresh.debug("Connected to: "+Refresh.webSocketUrl,1),Refresh.debug(e.data,3),Refresh.socket.send((new Date).getTime())},this.socket.onclose=function(e){"websocket"===Refresh.updateStrategy&&(Refresh.debug("Disconnected from WebSocket",1),Refresh.debug(e.data,3),setTimeout(Refresh.init(),3e3))},this.socket.onmessage=function(e){Refresh.debug("WebSocket sent: "+e.data,1),"ok"===e.data?Refresh.updateStrategy="websocket":"REFRESH_CSS"===e.data?Refresh.elements.map(function(e){"LINK"===e.tagName&&e.href&&Refresh.cssCallback(e)}):"REFRESH_JS"===e.data?Refresh.elements.map(function(e){"SCRIPT"===e.tagName&&e.src&&Refresh.jsCallback(e)}):Refresh.debug("Unknown command from websocket:"+e.data),Refresh.debug("update strategy is "+Refresh.updateStrategy,1)},window.onbeforeunload=function(){Refresh.socket.close()}}catch(e){this.debug("Client can't use websockets ? "+e.toString(),1),this.debug("update strategy is "+this.updateStrategy,1),setTimeout(function(){Refresh.poll()},this.timeout)}},cacheUrl:function(e){return e?(e=e.replace(/\?refresh-js=(\d+)/,""),e=e.replace(/&refresh-js=(\d+)/,""),e=e.replace(/refresh-js=(\d+)/,"")):""},uncacheUrl:function(e){if(!e)return"";e=e.replace(/#/,"");var t=1,r=e.match(/refresh-js=(\d+)/);return r&&(t=r[1],t++),e=e.search(/refresh-js=\d+/)>-1?e.replace(/refresh-js=(\d+)/,"refresh-js="+t):e.search(/\?/)>-1?e+"&refresh-js="+t:e+"?refresh-js="+t},work:function(){Refresh.debug("in work()",1);var e=function(e,t){var r=FlexDigest.hash(t),s=Refresh.cacheUrl(e);if(Refresh.urlTable[s]||(Refresh.urlTable[s]={}),Refresh.urlTable[s].hash=r,Refresh.urlTable[s].lastPoll=(new Date).getTime()/1e3,Refresh.urlTable[s].lastHash&&Refresh.urlTable[s].hash!==Refresh.urlTable[s].lastHash){Refresh.debug("should update "+s,2),Refresh.dump(Refresh.urlTable,2),t.length<1?Refresh.debug("data from "+s+" was null",2):t.length<500&&Refresh.debug(t,3);var o=Refresh.stack[s].callback;o(Refresh.stack[s].el)}Refresh.urlTable[s].lastHash=r};for(var t in Refresh.stack)t&&Refresh.stack.hasOwnProperty(t)&&(Refresh.showingNotification||Refresh.xget(t,e));"polling"===Refresh.updateStrategy&&setTimeout(function(){Refresh.poll()},Refresh.timeout)},poll:function(){Refresh.debug("in poll()",1),Refresh.elements.map(function(e){if(Refresh.debug(e.tagName+" "+e.getAttribute("type")+" "+e.getAttribute("src")+" "+e.getAttribute("id"),3),"SCRIPT"===e.tagName&&e.src)return void Refresh.trackUrl(e.src,e,Refresh.jsCallback);if("IMG"===e.tagName)return void Refresh.trackUrl(e.src,e,Refresh.imgCallback);var t=e.style.backgroundImage;t.match(/url\('?"?([^"]+)'?"?\)/i);return"LINK"===e.tagName&&e.href?void Refresh.trackUrl(e.href,e,Refresh.cssCallback):void 0}),"polling"===Refresh.updateStrategy&&setTimeout(function(){Refresh.work()},Refresh.timeout)},xget:function(e,t,r){var s=(new Date).getTime()/1e3,o=Refresh.cacheUrl(e);if(r||(r="HEAD"),Refresh.urlTable[o]&&Refresh.urlTable[o].lastPoll&&Math.abs(Refresh.urlTable[o].lastPoll-s)<Refresh.pollInterval)return void Refresh.debug(Math.abs(Refresh.urlTable[o].lastPoll-s),2);var a=new XMLHttpRequest;try{a=new XMLHttpRequest}catch(n){try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){return!1}}}a.onreadystatechange=function(){if(4===a.readyState)if("HEAD"===r){var s=a.getResponseHeader("ETag");s+=a.getResponseHeader("Last-Modified"),s+=a.getResponseHeader("Content-Length"),0===s&&Refresh.xget(e,t,"GET"),t(e,s)}else t(e,a.responseText)},a.open(r,e,!0),a.send()},trackUrl:function(e,t,r){var s=Refresh.cacheUrl(e);Refresh.stack[s]||(Refresh.stack[s]={}),Refresh.stack[s].next=Refresh.uncacheUrl(e),Refresh.stack[s].el=t,Refresh.stack[s].callback=r},skips:function(e){var t="";return[e.href,e.src].map(function(e){!t&&e&&(t=e.toString())}),t?-1===t.search(Refresh.mustMatch)||-1!==t.search(Refresh.mustNotMatch)?!0:!1:!0},formIterator:function(e){for(var t=document.getElementsByTagName("form"),r=0;r<t.length;r++)for(var s=0;s<document.forms[r].elements.length;s++)e(r,document.forms[r].elements[s])},saveState:function(){var e=function(e,t){var r=t.name,s=t.value;r&&s&&(Refresh.formStates+=e+":fdelim:"+encodeURIComponent(r)+":fdelim:"+encodeURIComponent(s)+":ldelim:")};this.formIterator(e),this.setCookie("formStates",this.formStates,70),this.debug("saving state",2),this.debug(Refresh.getCookie("formStates"),2)},restoreState:function(){Refresh.debug("formStates",1);var e=Refresh.getCookie("formStates");Refresh.debug(e,1),e.split(":ldelim:").map(function(e){var t=e.split(":fdelim:"),r=t[0],s=decodeURIComponent(t[1]),o=decodeURIComponent(t[2]);Refresh.debug(t,1),document.forms[r]&&document.forms[r][s]&&(document.forms[r][s].value=o)})},setCookie:function(e,t,r){var s=new Date;s.setTime(s.getTime()+1e3*r);var o="expires="+s.toUTCString();document.cookie=e+"="+t+";"+o+";domain="+window.location.host+";path=/"},getCookie:function(e){for(var t=e+"=",r=document.cookie.split(";"),s=0;s<r.length;s++){for(var o=r[s];" "===o.charAt(0);)o=o.substring(1);if(0===o.indexOf(t))return o.substring(t.length,o.length)}return""},widgetCss:function(){var e={"#rld-ctrl>h1":"font-size:22px;border-bottom:1px solid #999;","#rld-ctrl>i":"color:#f9f;","#rld-ctrl>a":"width:100px;color:#ccc;border:1px solid #999;padding:10px;margin:10px","#rld-ctrl>a:hover":"cursor:pointer;color:#fff;background:#999;",".rld-close":"font-size:20px;border:none !important;position:relative;top:0px;left:450px;","#rld-ctrl":"font-family:arial;color:#fff;background:#333;border:2px outset #999;width:500px;height:250px;position:fixed;right:1px;z-index:201;opacity:0.9;color:#fff;padding:0px 0px 10px 40px;",".rld-remember>label":"width:150px;left:5px;",".rld-remember":"display:block;height:20px;font-size:12px;margin-left:20px;"},t="<style>";for(var r in e)t+=r+" { "+e[r]+"} ";return t+="</style>"},drawWidget:function(e,t){var r="rld-ctrl";document.getElementById(r);var s=this.widgetCss(),o=document.createElement("div");o.setAttribute("id",r),o.style.top="1000px",s+='<a class="rld-close" style="color:#fff;" onClick="Refresh.closeWidget()">X</a>',s+=e,o.innerHTML=s,document.body.appendChild(o);var a=function(){var e=document.getElementById("rld-ctrl"),t=e.style.top.replace(/px$/,"");t>1&&(t-=90,1>t&&(t=1),e.style.top=t+"px",setTimeout(a,10))};return t?a():o.style.top="1px",!1},closeWidget:function(){var e=document.getElementById("rld-ctrl");e.parentNode.removeChild(e),Refresh.showingNotification=!1},setWidgetOption:function(e,t){Refresh.rldPrefs=t;var r=function(){Refresh.closeWidget(),Refresh.lastCallback(),Refresh.rldPrefs=""};if(document.getElementById("rld-remember").checked===!0){Refresh.setCookie("rldPrefs",t,31536e3),Refresh.closeWidget();var s="<h1 >Refresh preference saved</h1> <br>";return s+="<label>To reset your preferences, clear your browser's cookie cache.</label><br><br>",this.drawWidget(s,!1),void setTimeout(r,2e3)}"apply"===t?r():"ignore"===t&&(Refresh.closeWidget(),Refresh.rldPrefs="")},showNotification:function(e){var t=this.getCookie("rldPrefs");if(Refresh.debug("Refresh Preferences Cookie: "+t,1),t||(t=this.rldPrefs,Refresh.debug("Refresh Preferences Session: "+t,1)),t&&"apply"===t)return!0;if(t&&"ignore"===t)return!1;var r="<h1 >Refresh Notification</h1> <br>Changed Resource: <i>"+e+' </i> <br><br><br><a onClick="Refresh.setWidgetOption(\'global\', \'apply\');">Apply </a><a onClick="Refresh.setWidgetOption(\'global\', \'ignore\');">Ignore</a> <br><br> <form name="rld-remember" class="rld-remember"> <label>Always perform this action </label><input type="checkbox" id="rld-remember" name="rld-remember"value="remember" /></form>';return t?void 0:(this.drawWidget(r,"showAnimation"),this.showingNotification=!0,!1)},dump:function(e,t){t<=this.debugLevel&&console.log(e)}};window.addEventListener("load",function(){Refresh.init()});